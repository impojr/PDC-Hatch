import*as messaging from"messaging";import{settingsStorage as t}from"settings";function e(t,e){var i=e.SyncDate,a=e.SyncTime,o=new Date(i);let c=s(new Date),u=r(new Date);var h=0,f=0;if(i!=c){fetch(`https://api.fitbit.com/1.2/user/-/activities/steps/date/${i}/${i}/1min/time/${a}/23:59:00.json`,{method:"GET",headers:{Authorization:`Bearer ${t}`}}).then(function(t){return t.json()}).then(function(t){h+=parseInt(t["activities-steps"][0].value)}).catch(function(t){n()}),fetch(`https://api.fitbit.com/1.2/user/-/activities/calories/date/${i}/${i}/1min/time/${a}/23:59:00.json`,{method:"GET",headers:{Authorization:`Bearer ${t}`}}).then(function(t){return t.json()}).then(function(t){f+=parseInt(t["activities-calories"][0].value)}).catch(function(t){n()});var m=s(o.setDate(o.getDate()+1));fetch(`https://api.fitbit.com/1.2/user/-/activities/steps/date/${m}/${c}.json`,{method:"GET",headers:{Authorization:`Bearer ${t}`}}).then(function(t){return t.json()}).then(function(t){t["activities-steps"].forEach(function(t){h+=parseInt(t.value)})}).catch(function(t){n()}),fetch(`https://api.fitbit.com/1.2/user/-/activities/calories/date/${m}/${c}.json`,{method:"GET",headers:{Authorization:`Bearer ${t}`}}).then(function(t){return t.json()}).then(function(t){t["activities-calories"].forEach(function(t){f+=parseInt(t.value)})}).catch(function(t){n()})}else a!=u&&(fetch(`https://api.fitbit.com/1.2/user/-/activities/steps/date/${i}/${i}/1min/time/${a}/${u}.json`,{method:"GET",headers:{Authorization:`Bearer ${t}`}}).then(function(t){return t.json()}).then(function(t){h+=parseInt(t["activities-steps"][0].value)}).catch(function(t){n()}),fetch(`https://api.fitbit.com/1.2/user/-/activities/calories/date/${i}/${i}/1min/time/${a}/${u}.json`,{method:"GET",headers:{Authorization:`Bearer ${t}`}}).then(function(t){return t.json()}).then(function(t){f+=parseInt(t["activities-calories"][0].value)}).catch(function(t){n()}));setTimeout(function(){var t={SyncDate:c,SyncTime:u,Steps:h,Friendship:f},e=0!=h&&0!=f;messaging.peerSocket.readyState===messaging.peerSocket.OPEN&&e&&messaging.peerSocket.send(t)},3e3)}function n(){if(messaging.peerSocket.readyState===messaging.peerSocket.OPEN){messaging.peerSocket.send({SyncDate:"Error",SyncTime:"Error",Steps:"Error",Friendship:"Error"})}}function i(i){var s=!0;for(let n=0;n<t.length;n++){let r=t.key(n);if(r&&"oauth"===r){s=!1,e(JSON.parse(t.getItem(r)).access_token,i)}}s&&n()}function s(t){if(null!=t){var e=(t=new Date(t)).getDate(),n=t.getMonth()+1;return t.getFullYear()+"-"+(n<10?"0":"")+n+"-"+(e<10?"0":"")+e}return"00-00-0000"}function r(t){if(null!=t){var e=(t=new Date(t)).getHours(),n=t.getMinutes();return(e<10?"0":"")+e+":"+(n<10?"0":"")+n}return"00:00:00"}function a(t){return t.substring(0,4)}function o(t,e){var n=!1,i=!1;return t.substring(0,2)<e.substring(0,2)||(t.substring(0,2)==e.substring(0,2)?n=!0:t.substring(3,5)<=e.substring(3,5)&&(i=!0),n&&i)}messaging.peerSocket.onmessage=(t=>{i(t.data)}),messaging.peerSocket.onopen=(()=>{});